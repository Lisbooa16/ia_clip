{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Radar Viral</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'analysis/style.css' %}">
</head>
<body>
    <div class="page">
        <header class="hero">
            <div>
                <p class="eyebrow">Análise narrativa e estratégia viral</p>
                <h1>Radar Viral</h1>
                <p class="subtitle">Cole a URL do vídeo e receba uma decisão editorial clara.</p>
            </div>
        </header>

        <section class="card">
            <form method="post" class="form">
                {% csrf_token %}
                <label for="url">URL do vídeo (YouTube, TikTok ou Instagram)</label>
                <div class="form-row">
                    <input
                        id="url"
                        type="url"
                        name="url"
                        placeholder="https://"
                        value="{{ url }}"
                        required
                    >
                    <button type="submit">Analisar</button>
                </div>
                {% if error %}
                    <p class="error">{{ error }}</p>
                {% endif %}
            </form>
        </section>

        {% if result %}
            <section class="grid">
                <div class="card summary">
                    <h2>Resumo estratégico</h2>
                    <div class="score">
                        <div>
                            <p class="label">Score viral</p>
                            <p class="value">{{ result.score }}</p>
                        </div>
                        <span class="badge {{ result.score_label|lower }}">{{ result.score_label }}</span>
                    </div>

                    <div class="meta">
                        <p><strong>Plataforma:</strong> {{ result.platform|title }}</p>
                        <p><strong>Duração:</strong> {{ result.metadata.duration|default:"--" }}s</p>
                        <p><strong>Views:</strong> {{ result.metadata.views|default:"--" }}</p>
                        <p><strong>Engajamento:</strong> {{ result.metadata.engagement|default:"--" }}</p>
                    </div>

                    <div class="divider"></div>

                    <h3>Arquétipo narrativo</h3>
                    <p>{{ result.narrative_archetype }}</p>

                    <h3>Categoria viral</h3>
                    <p>{{ result.viral_category }}</p>

                    <h3>Motivação da audiência</h3>
                    <ul>
                        {% for item in result.audience_motivation %}
                            <li>{{ item }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="card">
                    <h2>Leitura da história</h2>
                    <p class="title">{{ result.metadata.title }}</p>
                    <p class="description">{{ result.metadata.description }}</p>

                    <div class="divider"></div>

                    <div class="story">
                        <div>
                            <h3>Evento central</h3>
                            <p>{{ result.story_insights.core_event }}</p>
                        </div>
                        <div>
                            <h3>Tensão narrativa</h3>
                            <p>{{ result.story_insights.narrative_tension }}</p>
                        </div>
                        <div>
                            <h3>Gatilho emocional</h3>
                            <p>{{ result.story_insights.emotional_pull }}</p>
                        </div>
                        <div>
                            <h3>Ângulo moral/social</h3>
                            <p>{{ result.story_insights.moral_angle }}</p>
                        </div>
                        <div>
                            <h3>Por que as pessoas compartilham</h3>
                            <p>{{ result.story_insights.share_reason }}</p>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <h3>Emoções acionadas</h3>
                    <ul class="chips">
                        {% for signal in result.emotional_triggers %}
                            <li>{{ signal }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </section>

            <section class="card decision">
                <div class="decision-title">
                    <h2>O que postar a seguir</h2>
                    <span class="decision-confidence">Confiança {{ result.confidence_label }}</span>
                </div>
                {% if result.editorial_decisions %}
                    <div class="decision-grid">
                        {% for decision in result.editorial_decisions %}
                            <article class="decision-card{% if decision.priority == 1 %} primary{% endif %}">
                                <div class="decision-header">
                                    <span class="decision-rank">Prioridade {{ decision.priority }}</span>
                                    <span class="decision-type">{{ decision.performance_type }}</span>
                                    <span class="decision-risk">Risco {{ decision.risk_level }}</span>
                                </div>
                                <h3>{{ decision.idea }}</h3>
                                <p class="decision-role">Papel: {{ decision.role }}</p>
                                <p class="decision-trigger">Gatilho psicológico: {{ decision.trigger }}</p>
                                <div class="blueprint">
                                    <h4>Blueprint</h4>
                                    <ul>
                                        <li><strong>Abertura:</strong> {{ decision.blueprint.opening }}</li>
                                        <li><strong>Setup:</strong> {{ decision.blueprint.setup }}</li>
                                        <li><strong>Contexto:</strong> {{ decision.blueprint.context }}</li>
                                        <li><strong>Tensão:</strong> {{ decision.blueprint.tension }}</li>
                                        <li><strong>Revelação:</strong> {{ decision.blueprint.reveal }}</li>
                                        <li><strong>Final:</strong> {{ decision.ending }}</li>
                                    </ul>
                                </div>
                                <p class="decision-why">{{ decision.rationale }}</p>
                                {% if decision.recommendation_note %}
                                    <p class="decision-note">{{ decision.recommendation_note }}</p>
                                {% endif %}
                                {% if decision.priority == 1 %}
                                    <div class="next-step">
                                        <h4>Se performar bem</h4>
                                        <p>{{ decision.next_if_success }}</p>
                                    </div>
                                    <div class="opening">
                                        <h4>Estratégias de abertura</h4>
                                        <ul>
                                            {% for strategy in decision.opening_strategies %}
                                                <li>{{ strategy }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% if result.sequence_preview %}
                                        <div class="sequence-preview">
                                            <h4>Prévia da sequência</h4>
                                            <ul>
                                                {% for preview in result.sequence_preview %}
                                                    <li>{{ preview.role|title }} • {{ preview.duration }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                    <form method="post" action="{% url 'analysis_generate_clip' %}" class="generate-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="url" value="{{ url }}">
                                        <input type="hidden" name="idea" value="{{ decision.idea }}">
                                        <input type="hidden" name="opening" value="{{ decision.blueprint.opening }}">
                                        <input type="hidden" name="setup" value="{{ decision.blueprint.setup }}">
                                        <input type="hidden" name="context" value="{{ decision.blueprint.context }}">
                                        <input type="hidden" name="tension" value="{{ decision.blueprint.tension }}">
                                        <input type="hidden" name="reveal" value="{{ decision.blueprint.reveal }}">
                                        <input type="hidden" name="ending" value="{{ decision.ending }}">
                                        <button type="submit" class="generate-clip">Gerar sequência de clips</button>
                                    </form>
                                {% endif %}
                                {% with blueprint_text="Abertura: "|add:decision.blueprint.opening|add:"\nSetup: "|add:decision.blueprint.setup|add:"\nContexto: "|add:decision.blueprint.context|add:"\nTensão: "|add:decision.blueprint.tension|add:"\nRevelação: "|add:decision.blueprint.reveal|add:"\nFinal: "|add:decision.ending %}
                                    <button class="copy-blueprint" data-blueprint="{{ blueprint_text|escapejs }}">Copiar blueprint</button>
                                {% endwith %}
                            </article>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="muted">Sem decisões fortes para recomendar neste momento.</p>
                {% endif %}
                {% if result.discarded_reason %}
                    <p class="decision-note">{{ result.discarded_reason }}</p>
                {% endif %}
            </section>

            {% if result.evidence_videos %}
                <section class="card evidence">
                    <h2>Evidências</h2>
                    <div class="evidence-grid">
                        {% for video in result.evidence_videos %}
                            <article class="evidence-card">
                                <div class="evidence-text">
                                    <p class="evidence-title"><a href="{{ video.url }}" target="_blank">{{ video.title }}</a></p>
                                    <p class="evidence-meta">{{ video.platform|title }} • {{ video.views|default:"--" }} views</p>
                                    <p class="evidence-why">O que funcionou: {{ video.narrative_take }}</p>
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}
        {% endif %}
    </div>
    <script>
        document.querySelectorAll('.copy-blueprint').forEach((button) => {
            button.addEventListener('click', async () => {
                const blueprint = button.dataset.blueprint;
                if (!blueprint) {
                    return;
                }
                try {
                    await navigator.clipboard.writeText(blueprint);
                    const original = button.textContent;
                    button.textContent = 'Copiado ✓';
                    setTimeout(() => {
                        button.textContent = original;
                    }, 1500);
                } catch (error) {
                    button.textContent = 'Falhou';
                }
            });
        });
    </script>
</body>
</html>
