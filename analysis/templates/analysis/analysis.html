{% load static %}
{% include "includes/_navbar.html" %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Radar Viral</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'analysis/style.css' %}">
    <style>
        .mode-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .mode-option {
            flex: 1;
            position: relative;
        }
        .mode-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        .mode-label {
            display: block;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }
        .mode-option input[type="radio"]:checked + .mode-label {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .mode-label:hover {
            background: #f9fafb;
        }
        .mode-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            color: #1f2937;
        }
        .mode-desc {
            font-size: 0.85rem;
            color: #6b7280;
        }
        .profile-selector {
            margin-bottom: 1rem;
        }
        .profile-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        .profile-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .blueprint-fields {
            display: none;
            margin-top: 1rem;
        }
        .blueprint-fields.active {
            display: block;
        }
        .blueprint-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        .blueprint-field label {
            display: block;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        .blueprint-field textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            resize: vertical;
        }
        .idea-field {
            margin-bottom: 1rem;
        }
        .idea-field input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="hero">
            <div>
                <p class="eyebrow">An√°lise narrativa e estrat√©gia viral</p>
                <h1>Radar Viral</h1>
                <p class="subtitle">Cole a URL do v√≠deo e receba uma decis√£o editorial clara.</p>
            </div>
        </header>

        <section class="card">
            <form method="post" class="form">
                {% csrf_token %}
                <label for="url">URL do v√≠deo (YouTube, TikTok ou Instagram)</label>
                <div class="form-row">
                    <input
                        id="url"
                        type="url"
                        name="url"
                        placeholder="https://"
                        value="{{ url }}"
                        required
                    >
                    <button type="submit">Analisar</button>
                </div>
                {% if error %}
                    <p class="error">{{ error }}</p>
                {% endif %}
            </form>
        </section>

        {% if result %}
            <section class="grid">
                <div class="card summary">
                    <h2>Resumo estrat√©gico</h2>
                    <div class="score">
                        <div>
                            <p class="label">Score viral</p>
                            <p class="value">{{ result.score }}</p>
                        </div>
                        <span class="badge {{ result.score_label|lower }}">{{ result.score_label }}</span>
                    </div>

                    <div class="meta">
                        <p><strong>Plataforma:</strong> {{ result.platform|title }}</p>
                        <p><strong>Dura√ß√£o:</strong> {{ result.metadata.duration|default:"--" }}s</p>
                        <p><strong>Views:</strong> {{ result.metadata.views|default:"--" }}</p>
                        <p><strong>Engajamento:</strong> {{ result.metadata.engagement|default:"--" }}</p>
                    </div>

                    <div class="divider"></div>

                    <h3>Arqu√©tipo narrativo</h3>
                    <p>{{ result.narrative_archetype }}</p>

                    <h3>Categoria viral</h3>
                    <p>{{ result.viral_category }}</p>

                    <h3>Motiva√ß√£o da audi√™ncia</h3>
                    <ul>
                        {% for item in result.audience_motivation %}
                            <li>{{ item }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="card">
                    <h2>Leitura da hist√≥ria</h2>
                    <p class="title">{{ result.metadata.title }}</p>
                    <p class="description">{{ result.metadata.description }}</p>

                    <div class="divider"></div>

                    <div class="story">
                        <div>
                            <h3>Evento central</h3>
                            <p>{{ result.story_insights.core_event }}</p>
                        </div>
                        <div>
                            <h3>Tens√£o narrativa</h3>
                            <p>{{ result.story_insights.narrative_tension }}</p>
                        </div>
                        <div>
                            <h3>Gatilho emocional</h3>
                            <p>{{ result.story_insights.emotional_pull }}</p>
                        </div>
                        <div>
                            <h3>√Çngulo moral/social</h3>
                            <p>{{ result.story_insights.moral_angle }}</p>
                        </div>
                        <div>
                            <h3>Por que as pessoas compartilham</h3>
                            <p>{{ result.story_insights.share_reason }}</p>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <h3>Emo√ß√µes acionadas</h3>
                    <ul class="chips">
                        {% for signal in result.emotional_triggers %}
                            <li>{{ signal }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </section>

            <section class="card decision">
                <div class="decision-title">
                    <h2>O que postar a seguir</h2>
                    <span class="decision-confidence">Confian√ßa {{ result.confidence_label }}</span>
                </div>
                {% if result.editorial_decisions %}
                    <div class="decision-grid">
                        {% for decision in result.editorial_decisions %}
                            <article class="decision-card{% if decision.priority == 1 %} primary{% endif %}">
                                <div class="decision-header">
                                    <span class="decision-rank">Prioridade {{ decision.priority }}</span>
                                    <span class="decision-type">{{ decision.performance_type }}</span>
                                    <span class="decision-risk">Risco {{ decision.risk_level }}</span>
                                </div>
                                <h3>{{ decision.idea }}</h3>
                                <p class="decision-role">Papel: {{ decision.role }}</p>
                                <p class="decision-trigger">Gatilho psicol√≥gico: {{ decision.trigger }}</p>
                                <div class="blueprint">
                                    <h4>Blueprint</h4>
                                    <ul>
                                        <li><strong>Abertura:</strong> {{ decision.blueprint.opening }}</li>
                                        <li><strong>Setup:</strong> {{ decision.blueprint.setup }}</li>
                                        <li><strong>Contexto:</strong> {{ decision.blueprint.context }}</li>
                                        <li><strong>Tens√£o:</strong> {{ decision.blueprint.tension }}</li>
                                        <li><strong>Revela√ß√£o:</strong> {{ decision.blueprint.reveal }}</li>
                                        <li><strong>Final:</strong> {{ decision.ending }}</li>
                                    </ul>
                                </div>
                                <p class="decision-why">{{ decision.rationale }}</p>
                                {% if decision.recommendation_note %}
                                    <p class="decision-note">{{ decision.recommendation_note }}</p>
                                {% endif %}
                                {% if decision.priority == 1 %}
                                    <div class="next-step">
                                        <h4>Se performar bem</h4>
                                        <p>{{ decision.next_if_success }}</p>
                                    </div>
                                    <div class="opening">
                                        <h4>Estrat√©gias de abertura</h4>
                                        <ul>
                                            {% for strategy in decision.opening_strategies %}
                                                <li>{{ strategy }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% if result.sequence_preview %}
                                        <div class="sequence-preview">
                                            <h4>Pr√©via da sequ√™ncia</h4>
                                            <ul>
                                                {% for preview in result.sequence_preview %}
                                                    <li>{{ preview.role|title }} ‚Ä¢ {{ preview.duration }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}

                                    <!-- üî• FORMUL√ÅRIO AJUSTADO COM MODO VIRAL/MANUAL -->
                                    <form method="post" action="{% url 'analysis_generate_clip' %}" class="generate-form" id="generateForm{{ forloop.counter }}">
                                        {% csrf_token %}
                                        <input type="hidden" name="url" value="{{ url }}">

                                        <!-- Seletor de Modo -->
                                        <div class="mode-selector">
                                            <div class="mode-option">
                                                <input type="radio" name="mode" value="viral" id="viral{{ forloop.counter }}" checked onchange="toggleMode({{ forloop.counter }}, 'viral')">
                                                <label for="viral{{ forloop.counter }}" class="mode-label">
                                                    <div class="mode-title">üöÄ Viral Autom√°tico</div>
                                                    <div class="mode-desc">IA detecta os melhores hooks</div>
                                                </label>
                                            </div>
                                            <div class="mode-option">
                                                <input type="radio" name="mode" value="manual" id="manual{{ forloop.counter }}" onchange="toggleMode({{ forloop.counter }}, 'manual')">
                                                <label for="manual{{ forloop.counter }}" class="mode-label">
                                                    <div class="mode-title">üìù Manual (Blueprint)</div>
                                                    <div class="mode-desc">Voc√™ define a estrutura</div>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Op√ß√µes Virais -->
                                        <div id="viralOptions{{ forloop.counter }}" class="profile-selector">
                                            <label for="profile{{ forloop.counter }}">Perfil do V√≠deo</label>
                                            <select name="profile" id="profile{{ forloop.counter }}">
                                                <option value="podcast">üéôÔ∏è Podcast / Entrevista</option>
                                                <option value="yt_game">üéÆ Gaming / YouTube</option>
                                                <option value="irl">üé• IRL / Vlog</option>
                                            </select>
                                        </div>

                                        <!-- Campos Blueprint (escondidos por padr√£o) -->
                                        <div id="blueprintFields{{ forloop.counter }}" class="blueprint-fields">
                                            <div class="idea-field">
                                                <label>Ideia Central</label>
                                                <input type="text" name="idea" value="{{ decision.idea }}" placeholder="Ex: O segredo da produtividade">
                                            </div>
                                            <div class="blueprint-grid">
                                                <div class="blueprint-field">
                                                    <label>Opening</label>
                                                    <textarea name="opening" rows="2">{{ decision.blueprint.opening }}</textarea>
                                                </div>
                                                <div class="blueprint-field">
                                                    <label>Setup</label>
                                                    <textarea name="setup" rows="2">{{ decision.blueprint.setup }}</textarea>
                                                </div>
                                                <div class="blueprint-field">
                                                    <label>Context</label>
                                                    <textarea name="context" rows="2">{{ decision.blueprint.context }}</textarea>
                                                </div>
                                                <div class="blueprint-field">
                                                    <label>Tension</label>
                                                    <textarea name="tension" rows="2">{{ decision.blueprint.tension }}</textarea>
                                                </div>
                                                <div class="blueprint-field">
                                                    <label>Reveal</label>
                                                    <textarea name="reveal" rows="2">{{ decision.blueprint.reveal }}</textarea>
                                                </div>
                                                <div class="blueprint-field">
                                                    <label>Ending</label>
                                                    <textarea name="ending" rows="2">{{ decision.ending }}</textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <button type="submit" class="generate-clip">Gerar clips agora</button>
                                    </form>
                                {% endif %}
                                {% with blueprint_text="Abertura: "|add:decision.blueprint.opening|add:"\nSetup: "|add:decision.blueprint.setup|add:"\nContexto: "|add:decision.blueprint.context|add:"\nTens√£o: "|add:decision.blueprint.tension|add:"\nRevela√ß√£o: "|add:decision.blueprint.reveal|add:"\nFinal: "|add:decision.ending %}
                                    <button class="copy-blueprint" data-blueprint="{{ blueprint_text|escapejs }}">Copiar blueprint</button>
                                {% endwith %}
                            </article>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="muted">Sem decis√µes fortes para recomendar neste momento.</p>
                {% endif %}
                {% if result.discarded_reason %}
                    <p class="decision-note">{{ result.discarded_reason }}</p>
                {% endif %}
            </section>

            {% if result.evidence_videos %}
                <section class="card evidence">
                    <h2>Evid√™ncias</h2>
                    <div class="evidence-grid">
                        {% for video in result.evidence_videos %}
                            <article class="evidence-card">
                                <div class="evidence-text">
                                    <p class="evidence-title"><a href="{{ video.url }}" target="_blank">{{ video.title }}</a></p>
                                    <p class="evidence-meta">{{ video.platform|title }} ‚Ä¢ {{ video.views|default:"--" }} views</p>
                                    <p class="evidence-why">O que funcionou: {{ video.narrative_take }}</p>
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}
        {% endif %}
    </div>
    <script>
        // Toggle entre modo Viral e Manual
        function toggleMode(formId, mode) {
            const viralOptions = document.getElementById('viralOptions' + formId);
            const blueprintFields = document.getElementById('blueprintFields' + formId);

            if (mode === 'viral') {
                viralOptions.style.display = 'block';
                blueprintFields.classList.remove('active');
            } else {
                viralOptions.style.display = 'none';
                blueprintFields.classList.add('active');
            }
        }

        // Copiar blueprint
        document.querySelectorAll('.copy-blueprint').forEach((button) => {
            button.addEventListener('click', async () => {
                const blueprint = button.dataset.blueprint;
                if (!blueprint) {
                    return;
                }
                try {
                    await navigator.clipboard.writeText(blueprint);
                    const original = button.textContent;
                    button.textContent = 'Copiado ‚úì';
                    setTimeout(() => {
                        button.textContent = original;
                    }, 1500);
                } catch (error) {
                    button.textContent = 'Falhou';
                }
            });
        });
    </script>
</body>
</html>
